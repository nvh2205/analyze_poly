{{- if .Values.postgresql.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-init-script
  labels:
    app: postgresql
data:
  init.sql: |
    -- Initialize database schema
    CREATE TABLE IF NOT EXISTS market_orderbooks (
        id BIGSERIAL PRIMARY KEY,
        market_hash VARCHAR(66) NOT NULL,
        asset_id VARCHAR(255) NOT NULL,
        timestamp BIGINT NOT NULL,
        bids JSONB,
        asks JSONB,
        last_trade_price DECIMAL(20, 10),
        created_at TIMESTAMP DEFAULT NOW()
    );

    -- Index for fast queries by asset and time
    CREATE INDEX idx_orderbooks_asset_time ON market_orderbooks (asset_id, timestamp DESC);
    CREATE INDEX idx_orderbooks_market_time ON market_orderbooks (market_hash, timestamp DESC);

    -- Optional: Add index for created_at for data retention queries
    CREATE INDEX idx_orderbooks_created_at ON market_orderbooks (created_at DESC);
{{- end }}

